<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<title>修改头像</title>
<meta content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="renderer" content="webkit" />
<meta name="keywords" content="择栖管理后台" />
<meta name="description" content="择栖工作室nb" />
<link rel="shortcut icon" href="/img/index/logo.jpg" />
<link href="/css/basic/bootstrap.min.css" rel="stylesheet" />
<link href="/css/basic/font-awesome.min.css" rel="stylesheet" />
<link href="/css/basic/animate.css" rel="stylesheet" />
<link href="/css/basic/style.css" rel="stylesheet" />
<link href="/plugin/css/toastr/toastr.min.css" rel="stylesheet">

<body class="gray-b">
<div class="wrapper wrapper-content">

    <div class="row">

        <div class="ibox float-e-margins col-sm-12">

            <div class="ibox-content col-sm-12">
                <input type="file" accept="images/*"  id="inputFile">

                <div class="container col-sm-4 col-sm-offset-4"></div>

                <div class="col-sm-4 col-sm-offset-4 inputFileView">

                    <button type="button" class="btn-info btn btn-w-m" id="upimgOfHead">选择上传图片</button>


                    <div>
                        <button class="submit btn btn-primary">Submit</button>
                    </div>
                </div>
            </div>

        </div>

    </div>
</div>
</body>


<!-- 全局js -->
<script src="/js/basic/jquery.min.js"></script>
<script src="/js/basic/bootstrap.min.js"></script>

<!-- 自定义js -->
<script src="/js/basic/content.js"></script>
<script src="/plugin/js/toastr/toastr.min.js"></script>
<script type="text/javascript" th:inline="javascript">
    var blob,fileName;
    $("#upimgOfHead").click(function(event) {
        $(".container img").css('display', 'block');
        $("#inputFile").trigger('click');

    });

    
    var tmp=$('<div class="resizer">'+
            '<div class="inner">'+
            '<img src=' + [[${session.student_info.headPic}]]  + '>'+
            '<div class="frames"></div>'+
            '</div>'+
            //'<button>&#10007;</button>'+
            '<button class="ok btn btn-success">&#10003;</button>'+
            '</div>');
    
    $.imageResizer=function(){
        if(Uint8Array&&HTMLCanvasElement&&atob&&Blob){

        }else{
            return false;
        }
        var resizer=tmp.clone();

        resizer.image=resizer.find('img')[0];
        resizer.frames=resizer.find('.frames');
        resizer.okButton=resizer.find('button.ok');
        resizer.frames.offset={
            top:0,
            left:0
        };
        
        resizer.okButton.click(function(){
            $(".container img").css('display', 'none');
            resizer.clipImage();
        });
       
        resizer.clipImage=function(){
        	
            var nh=this.image.naturalHeight,
                    nw=this.image.naturalWidth,
                    size=nw>nh?nh:nw;
                    
            size=size>1000?1000:size;
            //画布的宽高由上传图片的宽决定
            var canvas=$('<canvas width="'+size+'" height="'+size+'"></canvas>')[0],
                    ctx=canvas.getContext('2d'),
                    scale=nw/this.offset.width,
                    x=this.frames.offset.left*scale,
                    y=this.frames.offset.top*scale,
                    w=this.frames.offset.size*scale,
                    h=this.frames.offset.size*scale;

            ctx.drawImage(this.image,x,y,w,h,0,0,size,size);
            var src=canvas.toDataURL();
            this.canvas=canvas;
            this.append(canvas);
            this.addClass('uploading');
            this.removeClass('have-img');
          
            src=src.split(',')[1];
            if(!src)return this.doneCallback(null);
            src=window.atob(src);

            var ia = new Uint8Array(src.length);
            for (var i = 0; i < src.length; i++) {
                ia[i] = src.charCodeAt(i);
            };

            this.doneCallback(new Blob([ia], {type:"image/png"}));
            blob = new Blob([ia], {type:"image/png"});
        };
     
        resizer.resize=function(file,done){
            this.reset();
            this.doneCallback=done;
            this.setFrameSize(0);
            this.frames.css({
                top:0,
                left:0
            });
            var reader=new FileReader();
            reader.onload=function(){
                resizer.image.src=reader.result;
                reader=null;
                resizer.addClass('have-img');
                resizer.setFrames();
            };
            reader.readAsDataURL(file);
        };

        resizer.reset=function(){
            this.image.src='';
            this.removeClass('have-img');
            this.removeClass('uploading');
            this.find('canvas').detach();
        };

        resizer.setFrameSize=function(size){
            this.frames.offset.size=size;
            return this.frames.css({
                width:size+'px',
                height:size+'px'
            });
        };

        resizer.getDefaultSize=function(){
            var width=this.find(".inner").width(),
                    height=this.find(".inner").height();
            this.offset={
                width:width,
                height:height
            };
            console.log(this.offset);
            return width>height?height:width;
        };

        resizer.moveFrames=function(offset){
            var x=offset.x,
                    y=offset.y,
                    top=this.frames.offset.top,
                    left=this.frames.offset.left,
                    size=this.frames.offset.size,
                    width=this.offset.width,
                    height=this.offset.height;

            if(x+size+left>width){
                x=width-size;
            }else{
                x=x+left;
            };

            if(y+size+top>height){
                y=height-size;
            }else{
                y=y+top;
            };
            x=x<0?0:x;
            y=y<0?0:y;
            this.frames.css({
                top:y+'px',
                left:x+'px'
            });

            this.frames.offset.top=y;
            this.frames.offset.left=x;
        };
        (function(){
            var time;
            function setFrames(){
                var size=resizer.getDefaultSize();
                resizer.setFrameSize(size);
            };

            window.onresize=function(){
                clearTimeout(time)
                time=setTimeout(function(){
                    setFrames();
                },1000);
            };

            resizer.setFrames=setFrames;
        })();
        
        (function(){
            var lastPoint=null;
            function getOffset(event){
                event=event.originalEvent;
                var x,y;
                if(event.touches){
                    var touch=event.touches[0];
                    x=touch.clientX;
                    y=touch.clientY;
                }else{
                    x=event.clientX;
                    y=event.clientY;
                }

                if(!lastPoint){
                    lastPoint={
                        x:x,
                        y:y
                    };
                };

                var offset={
                    x:x-lastPoint.x,
                    y:y-lastPoint.y
                }
                lastPoint={
                    x:x,
                    y:y
                };
                return offset;
            };
            resizer.frames.on('touchstart mousedown',function(event){
                getOffset(event);
            });
            resizer.frames.on('touchmove mousemove',function(event){
                if(!lastPoint)return;
                var offset=getOffset(event);
                resizer.moveFrames(offset);
            });
            resizer.frames.on('touchend mouseup',function(event){
                lastPoint=null;
            });
        })();
        return resizer;
    };
    
    var resizer=$.imageResizer(),
            resizedImage;
    
    if(!resizer){
        resizer=$("<p>Your browser doesn't support these feature:</p><ul><li>canvas</li><li>Blob</li><li>Uint8Array</li><li>FormData</li><li>atob</li></ul>")
    };

    $('.container').append(resizer);

    $('input').change(function(event){
        var file=this.files[0];
        var isSuppot = false;
        fileName = file.name;
        if(fileName.lastIndexOf('.') == -1){
            toastr.error("还未选择上传的文件");
            return false;
        }
        var fileType = (fileName.substring(fileName.lastIndexOf(".")+1,fileName.length)).toLowerCase();
        var supportType = new Array();
        supportType[0] = 'png';
        supportType[1] = 'jpg';
        for (var i = 0;i <supportType.length;i++){
            if(supportType[i] == fileType){
                isSuppot = true;
            }
        };
        if(isSuppot ==false){
            toastr.error("请选择上传png或jpg格式的图片");
            return false;
        };
        resizer.resize(file,function(file){
            resizedImage=file;
        });
    });

    $('button.submit').click(function(){
        if(!blob){
            toastr.error('未选择上传头像');
            return;
        }
        var formData=new FormData();
        formData.append('file',blob,fileName);
        $.ajax({
            url: '/web/guy/headPic',
            type: 'post',
            dataType: 'json',
            cache: false,
            data:formData,
            processData: false,
            contentType: false,
        })
                .done(function(data) {    //上传成功
                    if(data.status == true){
                        toastr.success('头像修改成功');
                        var winparent = window.parent;   //向外层iframe发送修改的图片信息
                        var postdata = { "origin":"headimg","imgurl":data.jsonStr};
                        winparent.postMessage(postdata,"*");
                    }else{
                        toastr.error(data.errMsg);
                    }
                })
                .fail(function() {
                    toastr.error('网络异常，图片上传失败');
                })
                .always(function() {
                    console.log("complete");
                });
    });
</script>

</html>